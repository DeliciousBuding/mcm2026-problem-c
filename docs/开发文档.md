# 开发文档（中文）

## 1. 项目结构
- `src/pipeline.py`：主数据建模与可视化流水线（含必要注释）。
- `paper/main.tex`：论文主文件（含指标与图表嵌入）。
- `paper/figures/`：自动生成图表输出目录。
- `outputs/`：中间结果与汇总指标（JSON/CSV/LaTeX 宏）。
- `docs/`：开发文档与功能说明。

## 2. 环境与依赖
- 运行环境：Miniforge + `mcm2026`。
- 主要依赖：`numpy pandas matplotlib seaborn scipy statsmodels scikit-learn pulp`。
- 说明：Pulp 仅保留接口，实际 LP 求解已在极速版中跳过以提高速度。
- 可选环境变量：
  - `MCM_N_PROPOSALS`：采样规模（默认 250）。
  - `MCM_SCALES`：规模实验列表（例如 `2000,5000,20000`）。
  - `MCM_MULTIPROC`：是否启用多进程（`1` 启用，`0` 关闭）。
  - `MCM_WORKERS`：并行进程数（默认 `CPU-2`）。
  - `MCM_FAST_STRICT`：是否启用 Fast vs Strict 校验（默认开启）。
  - `MCM_STRICT_PROPS`：Fast vs Strict 校验规模（默认 2000）。
  - `MCM_STRICT_MAX_SAMPLES`：Strict 校验最大样本数（默认 600）。
  - `MCM_RULE_BOOT`：规则切换置信带 bootstrap 次数（默认 200）。

## 3. 数据输入
- 文件：`2026_MCM_Problem_C_Data.csv`。
- 格式：宽表，包含 `weekX_judgeY_score` 与选手元数据。

## 4. 运行流程
在项目根目录执行：
```bat
conda activate mcm2026
python -u src\pipeline.py
```

## 5. 输出产物
- 图表：`paper/figures/*.pdf`
- 汇总指标：`outputs/summary_metrics.json`、`outputs/summary_metrics.csv`
- LaTeX 宏：`paper/summary_metrics.tex`

## 6. 速度优化说明
- `sample_week_percent` 与 `lp_bounds_and_slack` 已替换为极速版本。
- 采样与约束检查向量化，LP 求解跳过。
- 机制评估已全向量化，移除逐样本 Python 循环。
- 参考运行耗时：N_PROPOSALS=250 时约 16–20 秒（单核，依机器而定）。
- 如需提升精度（N_PROPOSALS 上调），耗时近似线性增加，可使用多进程分季并行。

## 7. 性能实测（多进程）
- 机器：i7-14700HX（20 核 28 线程）
- 并行参数：`MCM_WORKERS=16`，多进程按赛季分发
- 记录（2026-01-31）：
  - N_PROPOSALS=2000：Runtime=22.11s，mean_hdi=0.407，max_hdi=0.954，stability=0.750，fit_tau=0.051
  - N_PROPOSALS=5000：Runtime=18.07s，mean_hdi=0.409，max_hdi=0.949，stability=0.749，fit_tau=0.050
  - N_PROPOSALS=20000：Runtime=21.61s，mean_hdi=0.410，max_hdi=0.950，stability=0.750，fit_tau=0.051
  - N_PROPOSALS=30000：Runtime=23.93s，mean_hdi=0.411，max_hdi=0.951，stability=0.749，fit_tau=0.050
  - N_PROPOSALS=50000：Runtime=30.01s，mean_hdi=0.411，max_hdi=0.951，stability=0.749，fit_tau=0.050
  - N_PROPOSALS=80000：Runtime=40.04s，mean_hdi=0.411，max_hdi=0.950，stability=0.749，fit_tau=0.050
  - N_PROPOSALS=100000：Runtime=44.58s，mean_hdi=0.411，max_hdi=0.951，stability=0.749，fit_tau=0.050
  - 规模对比表：`outputs/scale_benchmark.csv`（持续追加）
  - 规模对比图：`paper/figures/fig_scale_benchmark.pdf`
  - 拐点由图中虚线标注，用于规模选择说明

## 8. Fast vs Strict 校验（可信度）
- MAE(均值 fan share)：0.0045
- Top-1 一致率：76.7%
- Top-2 一致率：80.0%
- Flip-rate 变动：0.35%
- 指标差异（percent）：fairness 约 0.000、agency 约 0.003
- 输出：`outputs/fast_strict_metrics.json` + `paper/figures/fig_fast_vs_strict.pdf`

## 9. 论文编译
在 `paper` 目录执行：
```bat
pdflatex -interaction=nonstopmode -halt-on-error main.tex
xelatex -interaction=nonstopmode -halt-on-error main_zh.tex
```

## 10. 版本管理约定
- 每次关键迭代完成后执行 `git add` + `git commit`。
- 提交信息使用中文。

## 11. 当前进度（2026-01-31）
- 数据管道完成：完成从原始 CSV 到后验估计、指标计算与图表输出的全流程。
- 极速采样启用：`sample_week_percent` 和 `lp_bounds_and_slack` 使用极速版本，单核运行时间约 20 秒级（N_PROPOSALS=250）。
- 机制评估优化：淘汰与指标计算向量化，减少 Python 循环与中间存储。
- 图表齐全：已生成不确定性热图、错误淘汰热图、冲突散点、规则切换、DAWS 权衡、争议案例密度、决赛流向、预测 AUC 等图表。
- 论文集成完成：图表与指标已嵌入 `paper/main.tex`，ControlNumber 已更新为 2617892；中文报告 `paper/main_zh.tex` 可编译生成。
- 文档整理完成：根目录题目/规范/框架/题目详情文件已移动到 `docs/` 并做简要合并说明。
- 规模对比实验完成：已在多进程下运行 2000–100000 规模采样，生成 `scale_benchmark.csv` 与对比图，并写入报告与文档。
- 可信度校验完成：Fast vs Strict 校验与 Top-k 一致率、指标差异已写入报告。
- 视觉增强完成：新增 HDI 分布图、规则切换置信带、冲突组合图与机制对比图。
- 摘要页排版优化：Takeaway 居中拉宽，Core Results 与 Conflict Map 标题同一行。
