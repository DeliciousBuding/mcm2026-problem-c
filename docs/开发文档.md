更新日期：2026-02-01 | 版本：v0.3.3 | 说明：英文为准，中文可能滞后。

# 开发文档（中文）

## 0. 版本信息
- 当前版本：v0.3.3（2026-02-01）
- 版本维护位置：本文件头部与本节（主文档内不强制嵌入版本号，除非另行要求）。

## 1. 项目结构
- `src/pipeline.py`：主数据建模与可视化流水线（含必要注释）。
- `paper/main.tex`：论文主文件（含指标与图表嵌入）。
- `paper/figures/`：自动生成图表输出目录。
- `outputs/`：中间结果与汇总指标（JSON/CSV/LaTeX 宏）。
- `docs/`：开发文档与功能说明。

## 2. 代码规范

### 2.1 注释语言
- **Python 代码**：所有注释必须使用中文
- **LaTeX 代码**：所有注释必须使用中文
- **配置文件**：说明性注释使用中文

```python
# ✅ 正确示例
# 计算每周的冲突指数
conflict_idx = compute_kendall_tau(judge_rank, fan_rank)

# ❌ 错误示例
# compute weekly conflict index
conflict_idx = compute_kendall_tau(judge_rank, fan_rank)
```

```latex
% ✅ 正确示例
% 插入冲突热力图
\includegraphics{fig_conflict_map.pdf}

% ❌ 错误示例
% insert conflict heatmap
\includegraphics{fig_conflict_map.pdf}
```

## 3. 环境与依赖
- 运行环境：Miniforge + `mcm2026`。
- 主要依赖：`numpy pandas matplotlib seaborn scipy statsmodels scikit-learn pulp`。
- 说明：Pulp 仅保留接口，实际 LP 求解已在极速版中跳过以提高速度。
- 可选环境变量：
  - `MCM_N_PROPOSALS`：采样规模（默认 250）。
  - `MCM_SCALES`：规模实验列表（例如 `2000,5000,20000`）。
  - `MCM_MULTIPROC`：是否启用多进程（`1` 启用，`0` 关闭）。
  - `MCM_WORKERS`：并行进程数（默认 `CPU-2`）。
  - `MCM_FAST_STRICT`：是否启用 Fast vs Strict 校验（默认开启）。
  - `MCM_STRICT_PROPS`：Fast vs Strict 校验规模（默认 2000）。
  - `MCM_STRICT_MAX_SAMPLES`：Strict 校验最大样本数（默认 600）。
  - `MCM_RULE_BOOT`：规则切换置信带 bootstrap 次数（默认 200）。

## 4. 数据输入
- 文件：`2026_MCM_Problem_C_Data.csv`。
- 格式：宽表，包含 `weekX_judgeY_score` 与选手元数据。

## 5. 运行流程
在项目根目录执行：
```bat
conda activate mcm2026
python -u src\pipeline.py
```

## 6. 输出产物
- 图表：`paper/figures/*.pdf`
- 汇总指标：`outputs/summary_metrics.json`、`outputs/summary_metrics.csv`
- LaTeX 宏：`paper/summary_metrics.tex`

## 7. 速度优化说明
- `sample_week_percent` 与 `lp_bounds_and_slack` 已替换为极速版本。
- 采样与约束检查向量化，LP 求解跳过。
- 机制评估已全向量化，移除逐样本 Python 循环。
- 参考运行耗时：N_PROPOSALS=250 时约 16–20 秒（单核，依机器而定）。
- 如需提升精度（N_PROPOSALS 上调），耗时近似线性增加，可使用多进程分季并行。

## 8. 性能实测（多进程）
- 机器：i7-14700HX（20 核 28 线程）
- 并行参数：`MCM_WORKERS=16`，多进程按赛季分发
- 记录（2026-01-31）：
  - N_PROPOSALS=2000：Runtime=22.11s，mean_hdi=0.407，max_hdi=0.954，stability=0.750，fit_tau=0.051
  - N_PROPOSALS=5000：Runtime=18.07s，mean_hdi=0.409，max_hdi=0.949，stability=0.749，fit_tau=0.050
  - N_PROPOSALS=20000：Runtime=21.61s，mean_hdi=0.410，max_hdi=0.950，stability=0.750，fit_tau=0.051
  - N_PROPOSALS=30000：Runtime=23.93s，mean_hdi=0.411，max_hdi=0.951，stability=0.749，fit_tau=0.050
  - N_PROPOSALS=50000：Runtime=30.01s，mean_hdi=0.411，max_hdi=0.951，stability=0.749，fit_tau=0.050
  - N_PROPOSALS=80000：Runtime=40.04s，mean_hdi=0.411，max_hdi=0.950，stability=0.749，fit_tau=0.050
  - N_PROPOSALS=100000：Runtime=44.58s，mean_hdi=0.411，max_hdi=0.951，stability=0.749，fit_tau=0.050
  - 规模对比表：`outputs/scale_benchmark.csv`（持续追加）
  - 规模对比图：`paper/figures/fig_scale_benchmark.pdf`
  - 拐点由图中虚线标注，用于规模选择说明

## 9. Fast vs Strict 校验（可信度）
- MAE(均值 fan share)：0.0045
- Top-1 一致率：76.7%
- Top-2 一致率：80.0%
- Flip-rate 变动：0.35%
- 指标差异（percent）：fairness 约 0.000、agency 约 0.003
- 输出：`outputs/fast_strict_metrics.json` + `paper/figures/fig_fast_vs_strict.pdf`

## 10. 论文编译
在 `paper` 目录执行：
```bat
pdflatex -interaction=nonstopmode -halt-on-error main.tex
xelatex -interaction=nonstopmode -halt-on-error main_zh.tex
```

## 11. Git 工作流规范

### 11.1 分支策略

| 规则 | 说明 |
|------|------|
| **主分支只读** | 禁止在 `main` 上直接提交；所有开发工作在对应分支进行 |
| **任务分支纯粹** | 一个分支只做该 Block 的事情，不跨 Block 修改 |
| **语义清晰命名** | 分支名反映任务内容，如 `block0-method-alignment`、`docs-cleanup` |

### 11.2 分支命名规范

```
block<N>-<简要描述>     # Block 任务分支，如 block1-core-evidence
docs-<描述>             # 文档类任务，如 docs-cleanup
fix-<描述>              # 修复类任务，如 fix-figure-caption
feat-<描述>             # 功能类任务，如 feat-new-metric
```

### 11.3 提交规范

- **频繁提交**：分支内可多次提交，保持原子性
- **中文描述**：**所有 commit message 和 stash message 必须使用中文**，具体描述"做了什么"
- **即时推送**：每次 commit 后立即执行 `git push` 同步到远程

> ⚠️ **强制要求**：禁止使用英文提交信息。示例：
> - ✅ `git commit -m "完成 Block1 冲突指数计算与热力图生成"`
> - ❌ `git commit -m "fix bug"` 或 `git commit -m "update"`

```bash
# 正确示例
git add .
git commit -m "完成 Block1 冲突指数计算与热力图生成"
git push
```

### 11.4 分支切换与暂存

若当前任务未完成但需要处理其他任务（如紧急文档清理）：

```bash
# 1. 暂存当前工作（包括未跟踪文件）
git stash push -u -m "block1: 冲突指数计算进行中"

# 2. 切换到新分支处理其他任务
git checkout -b docs-cleanup
# ... 完成任务并提交 ...

# 3. 回到原分支继续工作
git checkout block1-core-evidence
git stash pop
```

### 11.5 合并与验收

1. **验收前自检**：
   - 确认仅涉及本 Block 的修改
   - 确认对其他 Block 无影响
   - 确认所有测试通过

2. **合并流程**：
   - 完成 Block 并通过验收口径后请求合并
   - 合并后提示打 tag（手动执行，不自动打）

3. **异常处理**：
   - 若发现任务不清、需跨 Block 修改或影响已完成 Block
   - **必须先停下**，整理好再继续，不能擅自扩展

### 11.6 版本管理

- 版本号维护在本文件"版本信息"节，作为统一入口
- Tag 命名格式：`v<主版本>.<次版本>.<修订号>`，如 `v0.3.3`

## 12. 当前进度（2026-02-01）
- 数据管道完成：完成从原始 CSV 到后验估计、指标计算与图表输出的全流程。
- 极速采样启用：`sample_week_percent` 和 `lp_bounds_and_slack` 使用极速版本，单核运行时间约 20 秒级（N_PROPOSALS=250）。
- 机制评估优化：淘汰与指标计算向量化，减少 Python 循环与中间存储。
- 图表齐全：已生成不确定性热图、错误淘汰热图、冲突散点、规则切换、DAWS 权衡、争议案例密度、决赛流向、预测 AUC 等图表。
- 论文集成完成：图表与指标已嵌入 `paper/main.tex`，ControlNumber 已更新为 2617892；中文报告 `paper/main_zh.tex` 可编译生成。
- 文档整理完成：根目录题目/规范/框架/题目详情文件已移动到 `docs/` 并做简要合并说明。
- 规模对比实验完成：已在多进程下运行 2000–100000 规模采样，生成 `scale_benchmark.csv` 与对比图，并写入报告与文档。
- 可信度校验完成：Fast vs Strict 校验与 Top-k 一致率、指标差异已写入报告。
- 视觉增强完成：新增 HDI 分布图、规则切换置信带、冲突组合图与机制对比图。
- 摘要页排版优化：Takeaway 居中拉宽，Core Results 与 Conflict Map 标题同一行。
